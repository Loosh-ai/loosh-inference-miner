[supervisord]
nodaemon=true
user=root
logfile=/dev/null
logfile_maxbytes=0
loglevel=info
pidfile=/tmp/supervisord.pid

[program:vllm]
command=bash -c 'source /workspace/.env 2>/dev/null || true; \
    : ${DEFAULT_MODEL:=mistralai/Mistral-7B-Instruct-v0.2}; \
    : ${TENSOR_PARALLEL_SIZE:=1}; \
    : ${GPU_MEMORY_UTILIZATION:=0.9}; \
    : ${MAX_MODEL_LEN:=4096}; \
    exec uv run vllm serve "$DEFAULT_MODEL" \
    --host 127.0.0.1 \
    --port 8001 \
    --tensor-parallel-size "$TENSOR_PARALLEL_SIZE" \
    --gpu-memory-utilization "$GPU_MEMORY_UTILIZATION" \
    --max-model-len "$MAX_MODEL_LEN"'
directory=/app
priority=10
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
startsecs=30
stopwaitsecs=30
environment=PATH="/app/.venv-docker/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

[program:miner]
command=bash -c 'source /workspace/.env 2>/dev/null || source .env 2>/dev/null || true; \
    WALLET_SOURCE=${WALLET_PATH:-/workspace/.bittensor/wallets}; \
    if [ -d "$WALLET_SOURCE" ] && [ "$(ls -A $WALLET_SOURCE 2>/dev/null)" ]; then \
        echo "Copying wallets from $WALLET_SOURCE to /root/.bittensor/wallets"; \
        mkdir -p /root/.bittensor/wallets; \
        cp -r $WALLET_SOURCE/* /root/.bittensor/wallets/; \
    fi; \
    exec uv run uvicorn miner.miner_server:app --host ${API_HOST:-0.0.0.0} --port ${API_PORT:-8000}'
directory=/app
priority=20
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
startsecs=10
stopwaitsecs=10
environment=PATH="/app/.venv-docker/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
